// import '../scss/main.scss'

// const mainPage = `
//         <div class="slider">
//             <div class="slide">
//                 <div class="slide__text">
//                     <p class="slide__title">Дом обедов</p>
//                     <p class="slide__sub-title">Нам 15 лет</p>
//                 </div>
//                 <img class="slide__img" src="/img/slider-bg.jpg" alt="slide">
//             </div>
//         </div>

//         <div class="banners">
//             <div class="banners__item banner">
//                 <img src="/img/banner-1.jpg" alt="" class="banner__img">
//                 <a href="#" class="banner__btn inline-btn">Перейти в меню &rarr;</a>
//             </div>
//             <div class="banners__item banner">
//                 <img src="/img/banner-2.jpg" alt="" class="banner__img">
//                 <a href="#" class="banner__btn inline-btn">Перейти в меню &rarr;</a>
//             </div>
//             <div class="banners__item banner">
//                 <img src="/img/banner-3.jpg" alt="" class="banner__img">
//                 <a href="#" class="banner__btn inline-btn">Перейти в меню &rarr;</a>
//             </div>
//             <div class="banners__item banner">
//                 <img src="/img/banner-4.jpg" alt="" class="banner__img">
//                 <a href="#" class="banner__btn inline-btn">Перейти в меню &rarr;</a>
//             </div>
//         </div>

//         <div class="top-products page-section">
//             <div class="wrapper">
//                 <ul class="tabs">
//                     <li class="tabs__item tabs__item--active">Фуршетные наборы</li>
//                     <li class="tabs__item">Топ продаж</li>
//                     <li class="tabs__item">Лучшее</li>
//                 </ul>
//                 <div class="cards">
//                     <div class="card-wrapper">
//                         <div class="card">
//                             <div class="card__photo">
//                                 <img class="card__img" src="/img/product-1.jpg" alt="product 1">
//                             </div>
//                             <div class="card__info">
//                                 <hr class="card__line">
//                                 <h3 class="card__title">card title</h3>
//                                 <hr class="card__line card__line--small">
//                                 <p class="card__price">2640.00$</p>
//                                 <div class="card__to-buy">
//                                     <span class="card__minus card__to-buy-buttons">-</span>
//                                     <span class="card__count">1</span>
//                                     <span class="card__plus card__to-buy-buttons">+</span>
//                                     <a href="#" class="card__btn-buy">Купить</a>
//                                 </div>
//                             <hr class="card__line">
//                             </div>
//                         </div>
//                     </div>
//                     <div class="card-wrapper">
//                         <div class="card">
//                             <div class="card__photo">
//                                 <img class="card__img" src="/img/product-1.jpg" alt="product 1">
//                             </div>
//                             <div class="card__info">
//                                 <hr class="card__line">
//                                 <h3 class="card__title">card title</h3>
//                                 <hr class="card__line card__line--small">
//                                 <p class="card__price">2640.00$</p>
//                                 <div class="card__to-buy">
//                                     <span class="card__minus card__to-buy-buttons">-</span>
//                                     <span class="card__count">1</span>
//                                     <span class="card__plus card__to-buy-buttons">+</span>
//                                     <a href="#" class="card__btn-buy">Купить</a>
//                                 </div>
//                             <hr class="card__line">
//                             </div>
//                         </div>
//                     </div>
//                     <div class="card-wrapper">
//                         <div class="card">
//                             <div class="card__photo">
//                                 <img class="card__img" src="/img/product-1.jpg" alt="product 1">
//                             </div>
//                             <div class="card__info">
//                                 <hr class="card__line">
//                                 <h3 class="card__title">card title</h3>
//                                 <hr class="card__line card__line--small">
//                                 <p class="card__price">2640.00$</p>
//                                 <div class="card__to-buy">
//                                     <span class="card__minus card__to-buy-buttons">-</span>
//                                     <span class="card__count">1</span>
//                                     <span class="card__plus card__to-buy-buttons">+</span>
//                                     <a href="#" class="card__btn-buy">Купить</a>
//                                 </div>
//                             <hr class="card__line">
//                             </div>
//                         </div>
//                     </div>
//                     <div class="card-wrapper">
//                         <div class="card">
//                             <div class="card__photo">
//                                 <img class="card__img" src="/img/product-1.jpg" alt="product 1">
//                             </div>
//                             <div class="card__info">
//                                 <hr class="card__line">
//                                 <h3 class="card__title">card title</h3>
//                                 <hr class="card__line card__line--small">
//                                 <p class="card__price">2640.00$</p>
//                                 <div class="card__to-buy">
//                                     <span class="card__minus card__to-buy-buttons">-</span>
//                                     <span class="card__count">1</span>
//                                     <span class="card__plus card__to-buy-buttons">+</span>
//                                     <a href="#" class="card__btn-buy">Купить</a>
//                                 </div>
//                             <hr class="card__line">
//                             </div>
//                         </div>
//                     </div>
//                 </div>
//             </div>
//         </div>
// `


// const page404 = `
//         <div class="page">
//             <div class="page__header">
//                 <div class="wrapper">
//                     <h2 class="page__title">Страница не найдена</h2>

//                     <div class="breadcrumbs">
//                         <ul class="breadcrumbs__list">
//                             <li class="breadcrumbs__item">
//                                 <a href="#" class="breadcrumbs__link">
//                                     <svg class="breadcrumbs__icon breadcrumbs__icon-home">
//                                         <use xlink:href="img/sprite.svg#icon-home"></use>
//                                     </svg>
//                                 </a>
//                             </li>
//                             <li class="breadcrumbs__item">
//                                 <a href="#" class="breadcrumbs__link">
                                    
//                                 </a>
//                             </li>
//                         </ul>
//                     </div>

//                 </div>
//             </div>
//             <div class="wrapper">
//                 <div class="cards">
                
//                 </div>
//             </div>
//         </div>
// `

// const elements = {
//     cart : document.getElementById('cart'),
//     logo : document.getElementById('logo'),
//     login : document.getElementById('login'),
//     signIn : document.getElementById('sign-in'),
//     content : document.getElementById('content'),
//     cards : document.getElementById('cards'),
//     barSearch: document.querySelector('.bar__search'),
//     searchInput: document.querySelector('.search__input'),
// }

// // Global state fo the app
// // ***************************
// const state = {}

// // *********************    API calls    ********************

// // // *********************************************
// // Search view

// const getInput = () => elements.searchInput.value

// const clearInput = () => {
//     elements.searchInput.value = ''
// }

// const clearContent = () => {
//     elements.cards.innerHTML = ''
// }

// const generatePage = (pageTitle, pagePath) => `
//     <div class="page">
//         <div class="page__header">
//             <div class="wrapper">
//                 <h2 class="page__title">${pageTitle}</h2>

//                 <div class="breadcrumbs">
//                     <ul class="breadcrumbs__list">
//                         <li class="breadcrumbs__item">
//                             <a href="#" class="breadcrumbs__link">
//                                 <svg class="breadcrumbs__icon breadcrumbs__icon-home">
//                                     <use xlink:href="img/sprite.svg#icon-home"></use>
//                                 </svg>
//                             </a>
//                         </li>
//                         <li class="breadcrumbs__item">
//                             <a href="#${pagePath}" class="breadcrumbs__link">
//                                 ${pageTitle}
//                             </a>
//                         </li>
//                     </ul>
//                 </div>

//             </div>
//         </div>
//         <div class="wrapper">
//             <div class="cards">
            
//             </div>
//         </div>
//     </div>
// `

// const renderRecipe = recipe => {
//     const cards = document.querySelector('.cards ')
//     const markup = `
//         <div class="card-wrapper">
//             <div href="#${recipe.recipe_id}" class="card">
//                 <div class="card__photo">
//                     <img class="card__img" src="${recipe.image_url}" alt="${recipe.image_url}">
//                 </div>
//                 <div class="card__info">
//                     <hr class="card__line">
//                     <h3 class="card__title">${recipe.title}</h3>
//                     <hr class="card__line card__line--small">
//                     <p class="card__price">2640.00$</p>
//                     <div class="card__to-buy">
//                         <span class="card__minus card__to-buy-buttons">-</span>
//                         <span class="card__count">1</span>
//                         <span class="card__plus card__to-buy-buttons">+</span>
//                         <a href="#" class="card__btn-buy">Купить</a>
//                     </div>
//                 <hr class="card__line">
//                 </div>
//             </div>
//         </div>
//     `
//     cards.insertAdjacentHTML('beforeend', markup)
// }

// const renderResults = recipes => {
//     recipes.forEach(renderRecipe)
// }
// // ***************************************************************
// // **************************
// // Search model 
// import axios from 'axios'
// class Search {
//     constructor(query) {
//         this.query = query
//     }

//     async getResults(query) {
//         try {
//             const res = await axios(`https://forkify-api.herokuapp.com/api/search?&q=${this.query}`);
//             this.result = res.data.recipes
//         }
//         catch (error) {
//             alert(error)
//         }
//     }
// }

// // *************************************
// // Search controller
// const controlSearch = async (query) => {
//     // 1. Get query from view
//     //todo

//     if (query) {

//         // 2) New search object and add to state
//         state.search = new Search(query)

//         // 3) Prepare UI for results
//         clearInput()
//         // clearContent()

//         // 4) Search for recipes
//         await state.search.getResults()

//         // 5) Render results on UI
//         renderResults(state.search.result)
//     }
// }
// // // **************************************


// // *********************    ROUTER    ***********************
// const routes = [
//     {
//         path: '',
//         title: 'Главная'
//     },
//     {
//         path: 'login',
//         title: 'Войти'
//     },
//     {
//         path: 'sign-in',
//         title: 'Регистрация'
//     },
//     {
//         path: 'cart',
//         title: 'Корзина'
//     },
//     {
//         path: 'pizza',
//         title: 'pizza'
//     },
//     {
//         path: 'pasta',
//         title: 'pasta'
//     },
//     {
//         path: 'steak',
//         title: 'steak '
//     },
//     {
//         path: 'hamburger',
//         title: 'hamburger'
//     },
//     {
//         path: 'seafood',
//         title: 'seafood'
//     },
//     {
//         path: 'chicken',
//         title: 'chicken'
//     },
//     {
//         path: 'salad',
//         title: 'salad'
//     },
//     {
//         path: 'set-lunch',
//         title: 'set-lunch'
//     },
// ]

// class Router {
//     constructor() {
//         this.content = elements.content
//         window.addEventListener("hashchange", e => this.onRouteChange(e))
//     }

//     onRouteChange(e) {
//         this.updatePage()

//         controlSearch(this.defineQuery())
//     }

//     getCurrentPage () {
//         this.routes = routes
//         const hashLocation = window.location.hash.substring(1)
//         const routeIndex = this.routes.findIndex(route => route.path === hashLocation)
//         const currentPage = this.routes[routeIndex]
//         let pageTemplate

//         switch (routeIndex) {
//             case -1:  
//                 pageTemplate = page404
//                 break
        
//             case 0:
//                 pageTemplate = mainPage
//                 break
        
//             default:
//                 pageTemplate = generatePage(currentPage.title, currentPage.path)
//                 break
//         }
//         const page = generatePage(pageTemplate)
//         return page
//     }

//     updatePage() {
//         this.content.innerHTML = this.getCurrentPage()
//     }

//     defineQuery() {
//         let query
//         const hashLocation = window.location.hash.substring(1)
//         const routeIndex = this.routes.findIndex(route => route.path === hashLocation)

//         switch (this.routes[routeIndex].path) {
//             case 'pizza':  
//                 query = 'pizza'    
//                 break
        
//             case 'pasta':
//                 query = 'pasta'
//                 break

//             case 'steak':
//                 query = 'steak'
//                 break

//             case 'hamburger':
//                 query = 'hamburger'
//                 break

//             case 'seafood':
//                 query = 'seafood'
//                 break

//             case 'chicken':
//                 query = 'chicken'
//                 break

//             case 'salad':
//                 query = 'salad'
//                 break

//             case 'set-lunch':
//                 query = 'set-lunch'
//                 break

//             default:
//                 query = 'salad'
//                 break
//         }
//         return query
//     }
// }

// new Router()


// // ********************************************************************************************
// // LIST MODEL
// import uniqid from 'uniqid'

// class List {
//     constructor () {
//         this.items = []
//     }

//     addItem(count, dish) {
//         const item = {
//             id: uniqid(),
//             count,
//             dish
//         }
//         this.items.push(items)
//     }

//     deleteItem(id) {
//         const index = this.items.findIndex(el => el.id === id)
//         this.items.splice(index, 1)
//     }

//     updateCount(id, newCount) {
//         this.items.find(el => el.id === id).count = newCount
//     }
// }


// // ********************************************************************************************
// // LIST VIEW
// const renderItem = item => {

// }


// const deleteItem = id => {
    
// }

import '../scss/main.scss'

import Search from './models/Search'
import List from './models/List'

import * as searchView from './views/searchView'
import * as pageView from './views/pageView'
import * as cardView from './views/cardView'
import * as listView from './views/listView'

import { elements } from './views/base'


// Global state fo the app
const state = {}


// Search controller
const controlSearch = async (query) => {
    // 1. Get query from view
    if (!query) {
        const query = searchView.getInput()
    }

    if (query) {

        // 2) New search object and add to state
        state.search = new Search(query)

        // 3) Prepare UI for results
        searchView.clearInput()
        searchView.clearContent()

        // 4) Search for recipes
        await state.search.getResults()

        // 5) Render results on UI
        searchView.renderResults(state.search.result)
    }
}

const listController = (card) => {
    // if (!state.list) state.list = new List()
    // state.list.addItem(card)
}



document.addEventListener('click', e => {
    if (e.target.matches('.card__to-buy, .card__to-buy *')) {
        const cardId = cardView.getId(e)
        const card = cardView.getCardById(cardId)

        if (e.target.matches('.card__plus, .card__plus *')) {
            cardView.increaseCount(cardId)
        } 
        
        else if (e.target.matches('.card__minus, .card__minus *')) {
            cardView.decreaseCount(cardId)
        } 
        
        else if (e.target.matches('.card__btn-buy, .card__btn-buy *')) {
            if (!state.list) state.list = new List()
            e.preventDefault()

            if (state.list.items.findIndex( item => item.oldId === cardId) === -1) {
                state.list.addItem(card)
            } else {
                const repeatItem = state.list.items.find( item => item.oldId === cardId)
                state.list.updateCount(repeatItem.id, repeatItem.count + card.count)
            }
            state.list.calcTotalSum()
            listView.showTotalSum(state.list.totalSum)
        }

    }
})

const handleShopingEvents = () => {
    if (document.querySelector('.shoping-list')) {
        const shoping = document.querySelector('.shoping-list')

        // listView.renderItems(state.list.items)
        // listView.showTotalSum(state.list.totalSum)

        shoping.addEventListener('click', e => {

            if (e.target.matches('.shoping-list__item-count-btn, .shoping-list__item-count-btn *')) {
                const item = e.target.parentElement.parentElement.parentElement  
                const itemId = item.getAttribute('data-itemid')  
                e.preventDefault()

                if (e.target.matches('.card__btn-delete, .card__btn-delete *')) {
                    state.list.deleteItem(itemId)
                    listView.deleteItem(itemId)
                } else if (e.target.matches('.shoping-list__item-plus, .shoping-list__item-plus *')) {
                    state.list.increaseCount(itemId)
                    listView.increaseCount(itemId)
                } else if (e.target.matches('.shoping-list__item-minus, .shoping-list__item-minus *')) {
                    state.list.decreaseCount(itemId)
                    listView.decreaseCount(itemId)
                }
                state.list.calcTotalSum()
                listView.showTotalSum(state.list.totalSum)
            }

        })
    }
}



const routes = [
    {
        path: '',
        title: 'Главная',
        content: '',
        dish: false
    },
    {
        path: 'login',
        title: 'Войти',
        content: pageView.login,
        dish: false
    },
    {
        path: 'sign-in',
        title: 'Регистрация',
        content: pageView.singIn,
        dish: false
    },
    {
        path: 'cart',
        title: 'Корзина',
        content: pageView.cart,
        dish: false
    },
    {
        path: 'pizza',
        title: 'pizza',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'pasta',
        title: 'pasta',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'steak',
        title: 'steak',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'hamburger',
        title: 'hamburger',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'seafood',
        title: 'seafood',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'chicken',
        title: 'chicken',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'salad',
        title: 'salad',
        content: pageView.cards,
        dish: true
    },
    {
        path: 'set-lunch',
        title: 'set-lunch',
        content: pageView.cards,
        dish: true
    },
]

class Router {
    constructor() {
        this.content = elements.content
        window.addEventListener("hashchange", e => this.onRouteChange(e))
    }

    onRouteChange(e) {
        const hashLocation = window.location.hash.substring(1)
        this.updatePage(this.getCurrentPage())
    }

    updatePage(page) {
        this.content.innerHTML = page
        this.showContent()
    }

    getCurrentPage () {
        this.routes = routes
        const hashLocation = window.location.hash.substring(1)
        const routeIndex = this.routes.findIndex(route => route.path === hashLocation)
        const currentRoute = this.routes[routeIndex]
        let currentPage

        if (this.routes[routeIndex].path === '') {
            currentPage = pageView.mainPage
        } else {
            currentPage = pageView.renderTemplatePage(currentRoute.title, currentRoute.path, currentRoute.content)
        }

        return currentPage
    }

    showContent() {
        const hashLocation = window.location.hash.substring(1)
        const routeIndex = this.routes.findIndex(route => route.path === hashLocation)
        const currentRoute = this.routes[routeIndex]

        if (currentRoute.dish) {
            controlSearch(currentRoute.path)
        } else if (currentRoute.path === 'cart') {
            handleShopingEvents()
            if (state.list) {
                listView.renderItems(state.list.items)
                listView.showTotalSum(state.list.totalSum)
            }
        }
    }
}

new Router()